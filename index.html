<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù„Ù… â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

<!-- Tailwind via CDN for rapid nice UI -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  /* Extra styling and small animations */
  body { background: linear-gradient(180deg,#071030,#021029); color: #e6eef8; font-family: Inter, system-ui, "Noto Naskh Arabic", sans-serif; }
  .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.04); }
  .tab-scroll { -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .tab-scroll::-webkit-scrollbar { display: none; }
  .fade { transition: all .22s ease; }
  .btn-accent { background: linear-gradient(90deg,#06b6d4,#7c3aed); color:#001; }
  .small-muted { color:#9fb3d6; font-size:13px; }
  .ad-overlay { position: fixed; inset:0; display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6); z-index:60; }
</style>
</head>
<body>

<div class="max-w-6xl mx-auto p-4 md:p-8">
  <!-- Header -->
  <header class="flex items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl md:text-4xl font-extrabold">ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù„Ù…</h1>
      <p class="small-muted">Ù…ÙƒØªØ¨Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… â€” ÙˆØ§Ø¬Ù‡Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆÙ…Ù…ÙŠØ²Ø©</p>
    </div>

    <div class="flex items-center gap-3">
      <button id="customerAreaBtn" class="px-3 py-2 rounded-full btn-accent shadow">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
      <button id="openAdmin" class="px-3 py-2 rounded-full glass border btn-accent">â‹®</button>
    </div>
  </header>

  <!-- Tabs (scrollable) -->
  <section class="mt-6">
    <div class="tab-scroll flex gap-3 overflow-x-auto py-2">
      <!-- Tabs injected by JS -->
    </div>
  </section>

  <!-- Search + actions -->
  <section class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
    <form id="searchForm" class="col-span-2 flex gap-2">
      <input id="kw" class="flex-1 p-3 rounded-lg glass border placeholder:text-slate-400" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶Ø©, ØªÙ…Ø§Ø±ÙŠÙ†)" />
      <button type="submit" class="px-4 rounded-lg btn-accent">ğŸ” Ø¨Ø­Ø«</button>
    </form>

    <div class="flex gap-2 justify-end">
      <button id="newPostBtn" class="px-4 py-2 rounded-lg glass">â• Ù†Ø´Ø± (ADM/ÙƒÙˆØ¯)</button>
      <button id="promoteBtn" class="px-4 py-2 rounded-lg btn-accent">Ø§Ù†Ø´Ø± 7 Ø£ÙŠØ§Ù… Ø¨Ù€ $3</button>
    </div>
  </section>

  <!-- Content grid -->
  <main class="mt-6">
    <div id="content" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>

    <div id="compareView" class="mt-6 glass p-4 rounded-lg hidden">
      <h3 class="font-bold">ğŸ“± Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ</h3>
      <table class="w-full mt-3 text-center">
        <thead><tr class="text-sm text-slate-300"><th class="p-2">Ø§Ù„Ù‡Ø§ØªÙ</th><th class="p-2">Ø§Ù„Ø±Ø§Ù…</th><th class="p-2">Ø§Ù„ØªØ®Ø²ÙŠÙ†</th><th class="p-2">Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©</th></tr></thead>
        <tbody id="compareTable"></tbody>
      </table>
    </div>
  </main>

  <footer class="mt-8 small-muted text-center">
    Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub Pages â€” Ø§Ù„Ù…Ù„Ù: <code>index.html</code>
  </footer>
</div>

<!-- Admin Modal -->
<div id="adminModal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="w-full max-w-2xl p-6 rounded-xl glass">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="font-bold text-lg">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† âš™ï¸</h2>
        <p class="small-muted">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ØŒ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§ØªØŒ ÙˆÙ†Ø´Ø± ÙŠØ¯ÙˆÙŠ.</p>
      </div>
      <div class="flex gap-2">
        <button id="shareFB" class="px-3 py-2 rounded-lg btn-accent">Ø±ÙˆØ¬ Ù„Ø¥Ø¹Ù„Ø§Ù†Ùƒ</button>
        <button id="closeAdmin" class="px-3 py-2 rounded-lg glass">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <hr class="my-4 border-slate-700">

    <!-- Login / Setup -->
    <div id="adminLoginBlock" class="">
      <label class="small-muted">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (ØªÙÙ‚Ø§Ø±Ù† Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ Ø¨Ù‡Ø§Ø´ Ù…Ø®Ø²Ù†)</label>
      <div class="mt-2 flex gap-2">
        <input id="adminPass" type="password" class="flex-1 p-3 rounded-lg glass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù†" />
        <button id="adminConfirm" class="px-4 py-2 rounded-lg btn-accent">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <p class="small-muted mt-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ù„ÙŠØ³Øª Ù…ÙØ¹Ø±Ø¶Ø©. Ø¥Ø°Ø§ Ù†Ø³ÙŠØªØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ø¨Ø± console (ØºÙŠØ± Ù…ÙØ³ØªØ­Ø³Ù† Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ùƒ-Ø§Ù†Ø¯).</p>
    </div>

    <!-- Panel -->
    <div id="adminPanelBlock" class="hidden mt-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="glass p-3 rounded-lg">
          <div class="font-semibold">ğŸ” ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯</div>
          <div class="mt-2 small-muted">ÙƒÙˆØ¯ ØµØ§Ù„Ø­ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â€” Ø£Ø¹Ø·Ù‡ Ù„Ù„Ø²Ø¨ÙˆÙ†.</div>
          <div class="mt-3 flex gap-2">
            <button id="genCode" class="px-3 py-2 rounded-lg btn-accent">ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯</button>
            <button id="showCodes" class="px-3 py-2 rounded-lg glass">Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
          </div>
        </div>

        <div class="glass p-3 rounded-lg">
          <div class="font-semibold">ğŸ“£ Ø±ÙØ¹ Ø¥Ø¹Ù„Ø§Ù†</div>
          <div class="mt-2 small-muted">ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ Ù„Ù„Ø²ÙˆØ§Ø± (Ù…Ø´Ø§Ù‡Ø¯Ø© Ù…Ù‚Ø·ÙˆØ¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…).</div>
          <input id="adFile" type="file" class="mt-2" />
          <div class="mt-2 flex gap-2">
            <select id="adType" class="p-2 rounded-lg glass">
              <option value="video">ÙÙŠØ¯ÙŠÙˆ (24 Ø«Ø§Ù†ÙŠØ©)</option>
              <option value="image">ØµÙˆØ±Ø© (5 Ø«ÙˆØ§Ù†ÙŠ)</option>
            </select>
            <button id="uploadAd" class="px-3 py-2 rounded-lg btn-accent">Ø±ÙØ¹</button>
          </div>
        </div>

        <div class="glass p-3 rounded-lg">
          <div class="font-semibold">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</div>
          <div class="mt-2 small-muted">Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (localStorage).</div>
          <div class="mt-3 space-y-2">
            <div class="flex justify-between"><span>ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø²ÙˆØ§Ø±</span><span id="statTotal" class="font-semibold">0</span></div>
            <div class="flex justify-between"><span>ğŸ”— Ù…Ù† ÙÙŠØ³Ø¨ÙˆÙƒ</span><span id="statFB" class="font-semibold">0</span></div>
            <div class="flex justify-between"><span>ğŸŒ Ù…Ø¨Ø§Ø´Ø±Ø©</span><span id="statDirect" class="font-semibold">0</span></div>
          </div>
        </div>
      </div>

      <div id="codesBox" class="mt-4 glass p-3 rounded-lg hidden"></div>

      <hr class="my-4 border-slate-700" />

      <div>
        <h3 class="font-semibold">Ù†Ø´Ø± ÙŠØ¯ÙˆÙŠ (Ø§Ù„Ø£Ø¯Ù…Ù†)</h3>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="pTitle" placeholder="Ø¹Ù†ÙˆØ§Ù†" class="p-3 rounded-lg glass" />
          <input id="pKw" placeholder="ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)" class="p-3 rounded-lg glass" />
          <textarea id="pDesc" placeholder="ÙˆØµÙ" class="p-3 rounded-lg glass col-span-2"></textarea>
          <select id="pCat" class="p-3 rounded-lg glass">
            <!-- filled by JS -->
          </select>
          <input id="pFiles" type="file" multiple class="col-span-2" />
          <div class="col-span-2 flex gap-2">
            <button id="publishNow" class="px-4 py-2 rounded-lg btn-accent">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            <button id="logoutAdmin" class="px-4 py-2 rounded-lg glass">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Customer area modal -->
<div id="customerModal" class="fixed inset-0 hidden items-center justify-center z-40">
  <div class="w-full max-w-xl p-6 rounded-xl glass">
    <div class="flex justify-between">
      <h3 class="font-bold">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</h3>
      <button id="closeCustomer" class="px-3 py-1 rounded-lg glass">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="mt-3">
      <label class="small-muted">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ„Ù…ØªÙ‡</label>
      <div class="flex gap-2 mt-2">
        <input id="customerCode" class="flex-1 p-3 rounded-lg glass" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯" />
        <button id="redeemCode" class="px-3 py-2 rounded-lg btn-accent">ØªØ­Ù‚Ù‚</button>
      </div>

      <div id="customerFormWrap" class="mt-4 hidden">
        <p class="small-muted">Ø§Ù„ÙƒÙˆØ¯ ØµØ­ÙŠØ­ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.</p>
        <input id="custTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="p-3 rounded-lg glass mt-2" />
        <input id="custKw" placeholder="ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ©" class="p-3 rounded-lg glass mt-2" />
        <textarea id="custDesc" placeholder="Ø§Ù„ÙˆØµÙ" class="p-3 rounded-lg glass mt-2"></textarea>
        <select id="custCat" class="p-3 rounded-lg glass mt-2">
          <!-- filled by JS -->
        </select>
        <input id="custFiles" type="file" multiple class="mt-2" />
        <div class="mt-3 flex gap-2">
          <button id="custPublish" class="px-4 py-2 rounded-lg btn-accent">Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ad Modal -->
<div id="adModal" class="hidden ad-overlay">
  <div id="adHolder" class="w-full max-w-3xl p-4 rounded-lg glass"></div>
</div>

<script>
/* -------------------------
   Core client-only implementation
   ------------------------- */

/* Precomputed sha256( '2009bbh2009' ) stored as ADMIN_HASH (we do not display password) */
const ADMIN_HASH = "5116bd58b6757e5a6d5396543a8c10d55a0ca3cb44d3dd1503c6ac5ae74b34f6";

/* Utility helpers */
function uid(){ return Math.random().toString(36).slice(2,9) }
function now(){ return Date.now() }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function load(k, fallback){ try{ const v = JSON.parse(localStorage.getItem(k)); return v===null? fallback : (v||fallback); }catch(e){ return fallback } }

/* Data stores in localStorage:
   m_posts: array of posts
   m_codes: array of {code, days, createdAt, used:false}
   m_ad: {type, data, length}
   visitors: numbers
*/

/* Default categories */
const CATEGORIES = [
  { key:'media', title:'ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø¢Ù„ÙŠ' },
  { key:'electronics', title:'Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ùˆ Ù…Ù†Ø²Ù„ÙŠØ©' },
  { key:'games', title:'Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨' },
  { key:'health', title:'Ø§Ù„ØµØ­Ø© ÙˆØ±ÙŠØ§Ø¶Ø©' },
  { key:'phones', title:'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ' }
];

/* Simple SHA-256 hex function */
async function sha256hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* Initialize minimal demo posts if empty */
if(!load('m_posts', null)) {
  save('m_posts', [
    { _id: uid(), title:'Ù†ØµØ§Ø¦Ø­ Ø±ÙŠØ§Ø¶ÙŠØ© ØµØ¨Ø§Ø­ÙŠØ©', description:'ØªÙ…Ø§Ø±ÙŠÙ† Ø¨Ø³ÙŠØ·Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙŠÙˆÙ…', media:[], link:'', categoryKey:'health', keywords:['Ø±ÙŠØ§Ø¶Ø©','ØªÙ…Ø§Ø±ÙŠÙ†'], createdAt: now(), expiresAt: now() + 7*24*3600*1000 },
    { _id: uid(), title:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù‡Ø§ØªÙ', description:'Ù…Ù…ÙŠØ²Ø§Øª ÙˆØ£Ø¯Ø§Ø¡', media:[], link:'', categoryKey:'media', keywords:['Ù…Ø±Ø§Ø¬Ø¹Ø©','Ù‡Ø§ØªÙ'], createdAt: now(), expiresAt: now() + 7*24*3600*1000 }
  ]);
}

/* Visit tracking (local-only) */
(function trackVisit(){
  const total = (parseInt(localStorage.getItem('vis_total')||'0') + 1);
  localStorage.setItem('vis_total', total);
  const ref = document.referrer || '';
  if(ref.includes('facebook.com')) {
    localStorage.setItem('vis_fb', (parseInt(localStorage.getItem('vis_fb')||'0')+1));
  } else {
    localStorage.setItem('vis_direct', (parseInt(localStorage.getItem('vis_direct')||'0')+1));
  }
})();

/* UI elements */
const tabsContainer = document.querySelector('.tab-scroll');
const content = document.getElementById('content');
const compareView = document.getElementById('compareView');
const compareTable = document.getElementById('compareTable');

/* build tabs */
let active = 'media';
function buildTabs(){
  tabsContainer.innerHTML = '';
  CATEGORIES.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className = 'px-4 py-2 rounded-full glass fade tab-btn';
    btn.textContent = cat.title;
    btn.addEventListener('click', ()=> setActive(cat.key));
    if(cat.key === active) btn.classList.add('btn-accent');
    tabsContainer.appendChild(btn);
  });
}
buildTabs();

/* setActive */
function setActive(key){
  active = key;
  Array.from(tabsContainer.children).forEach(b=>{
    b.classList.toggle('btn-accent', b.textContent === CATEGORIES.find(c=>c.key===key).title);
  });
  document.getElementById('kw').value = '';
  if(key === 'phones'){
    compareView.classList.remove('hidden');
    content.classList.add('hidden');
    renderCompare();
  } else {
    compareView.classList.add('hidden');
    content.classList.remove('hidden');
    renderPosts();
  }
}

/* render posts for active category */
function renderPosts(){
  const posts = (load('m_posts',[])||[]).filter(p=> p.categoryKey === active && (!p.expiresAt || p.expiresAt > now()));
  content.innerHTML = '';
  if(posts.length === 0){
    content.innerHTML = `<div class="col-span-full glass p-6 rounded-lg text-center small-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§Ù†Ø© Ø¨Ø¹Ø¯.</div>`;
    return;
  }
  posts.sort((a,b)=>b.createdAt - a.createdAt);
  posts.forEach(p=>{
    const card = document.createElement('article');
    card.className = 'glass p-4 rounded-lg';
    let inner = `<div class="small-muted">${escapeHtml(p.categoryKey)} â€¢ ${new Date(p.createdAt).toLocaleString()}</div>
                 <h3 class="font-bold mt-2">${escapeHtml(p.title)} <span class="ml-2">âœ¨</span></h3>
                 <p class="mt-2 small-muted">${escapeHtml(p.description).slice(0,160)}</p>`;
    if(p.media && p.media.length){
      const m = p.media[0];
      if(m.type.startsWith('image')) inner += `<img src="${m.url}" alt="" class="mt-3 rounded-lg w-full" />`;
      else if(m.type.startsWith('video')) inner += `<video src="${m.url}" controls class="mt-3 rounded-lg w-full"></video>`;
    }
    card.innerHTML = inner;
    content.appendChild(card);
  });
}

/* compare */
function renderCompare(){
  compareTable.innerHTML = '';
  const data = [
    { name:'iPhone 15', ram:'6GB', storage:'128GB', battery:'4000mAh' },
    { name:'Samsung S24', ram:'12GB', storage:'256GB', battery:'5000mAh' }
  ];
  data.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${d.name}</td><td class="p-2">${d.ram}</td><td class="p-2">${d.storage}</td><td class="p-2">${d.battery}</td>`;
    compareTable.appendChild(tr);
  });
}

/* search (keywords-first) */
document.getElementById('searchForm').addEventListener('submit', e=>{
  e.preventDefault();
  const q = document.getElementById('kw').value.trim().toLowerCase();
  if(!q){ renderPosts(); return; }
  const posts = (load('m_posts',[])||[]).filter(p=> p.categoryKey === active && (
    (p.keywords||[]).some(k=> k.toLowerCase().includes(q)) ||
    (p.title||'').toLowerCase().includes(q) ||
    (p.description||'').toLowerCase().includes(q)
  ));
  content.innerHTML = '';
  if(posts.length===0){ content.innerHTML = `<div class="glass p-6 rounded-lg small-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`; return; }
  posts.forEach(p=>{
    const card = document.createElement('article'); card.className = 'glass p-4 rounded-lg';
    card.innerHTML = `<div class="small-muted">${escapeHtml(p.categoryKey)}</div><h3 class="font-bold">${escapeHtml(p.title)}</h3><p class="small-muted">${escapeHtml(p.description)}</p>`;
    content.appendChild(card);
  });
});

/* escape helper */
function escapeHtml(s){ return (s||'').toString().replaceAll('<','&lt;').replaceAll('>','&gt;') }

/* Buttons wiring */
document.getElementById('openAdmin').addEventListener('click', ()=> { document.getElementById('adminModal').classList.remove('hidden'); });
document.getElementById('closeAdmin').addEventListener('click', ()=> { document.getElementById('adminModal').classList.add('hidden'); });
document.getElementById('newPostBtn').addEventListener('click', ()=> { document.getElementById('customerModal').classList.remove('hidden'); });
document.getElementById('closeCustomer').addEventListener('click', ()=> { document.getElementById('customerModal').classList.add('hidden'); });
document.getElementById('promoteBtn').addEventListener('click', ()=> { window.open("https://www.facebook.com/profile.php?id=61580406166615&mibextid=rS40aB7S9Ucbxw6v",'_blank'); });
document.getElementById('shareFB').addEventListener('click', ()=> { window.open("https://www.facebook.com/profile.php?id=61580406166615&mibextid=rS40aB7S9Ucbxw6v",'_blank'); });

/* Populate category selects */
function fillCatSelects(){
  const pCat = document.getElementById('pCat');
  const custCat = document.getElementById('custCat');
  pCat.innerHTML = ''; custCat.innerHTML = '';
  CATEGORIES.filter(c=>c.key!=='phones').forEach(c=>{
    const o = document.createElement('option'); o.value=c.key; o.textContent=c.title;
    pCat.appendChild(o);
    const o2 = o.cloneNode(true); custCat.appendChild(o2);
  });
}
fillCatSelects();

/* Admin login (compare SHA-256 to precomputed hash) */
document.getElementById('adminConfirm').addEventListener('click', async ()=>{
  const v = document.getElementById('adminPass').value.trim();
  if(!v) return alert('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù†');
  const hv = await sha256hex(v);
  if(hv === ADMIN_HASH){
    document.getElementById('adminLoginBlock').classList.add('hidden');
    document.getElementById('adminPanelBlock').classList.remove('hidden');
    document.getElementById('adminPass').value = '';
    refreshStats();
    renderPosts();
    showCodesBox(false);
  } else {
    alert('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
  }
});

/* Logout admin */
document.getElementById('logoutAdmin').addEventListener('click', ()=>{
  document.getElementById('adminPanelBlock').classList.add('hidden');
  document.getElementById('adminLoginBlock').classList.remove('hidden');
});

/* Generate code (one-time) */
document.getElementById('genCode').addEventListener('click', ()=>{
  const codes = load('m_codes',[]);
  const code = 'MK-' + Math.random().toString(36).slice(2,8).toUpperCase();
  codes.push({ code, days:7, createdAt: now(), used:false });
  save('m_codes', codes);
  alert('ØªÙˆÙ„Ø¯ ÙƒÙˆØ¯: ' + code + '\nØ§Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‡Ø¯ÙŠÙ‡ Ù„Ù„Ø²Ø¨ÙˆÙ†. ØµØ§Ù„Ø­ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.');
  showCodesBox(true);
});

/* Show codes list */
document.getElementById('showCodes').addEventListener('click', ()=> showCodesBox(true));
function showCodesBox(show){
  const box = document.getElementById('codesBox');
  const codes = load('m_codes',[]);
  if(codes.length === 0) box.innerHTML = '<div class="small-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…ÙˆÙ„Ø¯Ø© Ø¨Ø¹Ø¯.</div>';
  else box.innerHTML = `<div class="font-semibold">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø© (${codes.length})</div>` + codes.map(c=>`<div class="mt-2 p-2 glass rounded flex justify-between items-center"><div>${c.code} â€” ${c.used? '<span class="small-muted">Ù…Ø³ØªØ®Ø¯Ù…</span>':'<span class="font-semibold">Ù…ØªØ§Ø­</span>'}</div><div><button class="copyBtn px-2 py-1 rounded glass" data-code="${c.code}">Ù†Ø³Ø®</button></div></div>`).join('');
  box.classList.toggle('hidden', !show);
  // attach copy handlers
  box.querySelectorAll('.copyBtn').forEach(btn=> btn.addEventListener('click', ()=> {
    navigator.clipboard?.writeText(btn.dataset.code).then(()=> alert('Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©'));
  }));
}

/* Publish Now (admin) */
document.getElementById('publishNow').addEventListener('click', async ()=>{
  const title = document.getElementById('pTitle').value.trim();
  const desc = document.getElementById('pDesc').value.trim();
  const kws = document.getElementById('pKw').value.split(',').map(s=>s.trim()).filter(Boolean);
  const cat = document.getElementById('pCat').value;
  const files = document.getElementById('pFiles').files;
  if(!title) return alert('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹');
  const media = [];
  for(const f of files) media.push({ url: await fileToDataURL(f), type: f.type });
  const posts = load('m_posts',[]);
  const createdAt = now();
  posts.push({ _id: uid(), title, description: desc, media, link:'', categoryKey: cat, keywords: kws, createdAt, expiresAt: createdAt + 7*24*3600*1000 });
  save('m_posts', posts);
  alert('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
  document.getElementById('pTitle').value=''; document.getElementById('pDesc').value=''; document.getElementById('pKw').value=''; document.getElementById('pFiles').value='';
  renderPosts();
});

/* Upload Ad */
document.getElementById('uploadAd').addEventListener('click', async ()=>{
  const f = document.getElementById('adFile').files[0];
  const type = document.getElementById('adType').value;
  if(!f) return alert('Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
  const data = await fileToDataURL(f);
  save('m_ad', { type, data, length: type==='video'?24:5 });
  alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø­Ù„ÙŠØ§Ù‹.');
});

/* Show ad to user when needed */
async function showAdIfNeeded(){
  const ad = load('m_ad', null);
  const access = parseInt(localStorage.getItem('adAccessUntil')||'0',10);
  if(!ad) return;
  if(access > now()) return;
  // show modal
  const adModal = document.getElementById('adModal');
  const adHolder = document.getElementById('adHolder');
  adHolder.innerHTML = '';
  if(ad.type === 'video'){
    const v = document.createElement('video'); v.src = ad.data; v.controls = true; v.autoplay = true; v.style.width = '100%';
    adHolder.appendChild(v);
    const info = document.createElement('div'); info.className = 'small-muted mt-2'; info.textContent = `Ø´Ø§Ù‡Ø¯ ${ad.length} Ø«Ø§Ù†ÙŠØ© Ù„ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø©.`;
    adHolder.appendChild(info);
    adModal.classList.remove('hidden');
    const interval = setInterval(()=> {
      try{
        if(Math.floor(v.currentTime) >= ad.length){
          clearInterval(interval);
          adModal.classList.add('hidden');
          localStorage.setItem('adAccessUntil', (now() + 24*3600*1000));
          alert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.');
        }
      }catch(e){}
    }, 500);
  } else {
    const img = document.createElement('img'); img.src = ad.data; img.style.width = '100%';
    adHolder.appendChild(img);
    adModal.classList.remove('hidden');
    setTimeout(()=> { adModal.classList.add('hidden'); localStorage.setItem('adAccessUntil', (now() + 24*3600*1000)); alert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.'); }, 5000);
  }
}

/* Customer: redeem code -> allow publish one */
document.getElementById('redeemCode').addEventListener('click', ()=>{
  const code = document.getElementById('customerCode').value.trim();
  if(!code) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯');
  const codes = load('m_codes',[]);
  const found = codes.find(c=> c.code === code && !c.used);
  if(!found) return alert('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù…');
  // mark code temporarily as allocated to this customer session (not used until publish)
  sessionStorage.setItem('allocated_code', code);
  // show customer form
  document.getElementById('customerFormWrap').classList.remove('hidden');
});

/* Customer publish */
document.getElementById('custPublish').addEventListener('click', async ()=>{
  const code = sessionStorage.getItem('allocated_code');
  if(!code) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯');
  const title = document.getElementById('custTitle').value.trim();
  const desc = document.getElementById('custDesc').value.trim();
  const kws = document.getElementById('custKw').value.split(',').map(s=>s.trim()).filter(Boolean);
  const cat = document.getElementById('custCat').value;
  const files = document.getElementById('custFiles').files;
  if(!title) return alert('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†');
  const media = [];
  for(const f of files) media.push({ url: await fileToDataURL(f), type: f.type });
  const posts = load('m_posts',[]);
  const createdAt = now();
  posts.push({ _id: uid(), title, description: desc, media, link:'', categoryKey: cat, keywords: kws, createdAt, expiresAt: createdAt + 7*24*3600*1000 });
  save('m_posts', posts);
  // mark code used
  const codes = load('m_codes',[]);
  const idx = codes.findIndex(c=>c.code === code);
  if(idx>=0){ codes[idx].used = true; codes[idx].usedAt = now(); save('m_codes', codes); }
  // prevent reuse: clear session allocation
  sessionStorage.removeItem('allocated_code');
  alert('Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ â€” Ø§Ù„ÙƒÙˆØ¯ Ø£ØµØ¨Ø­ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹.');
  document.getElementById('customerModal').classList.add('hidden');
  // refresh
  renderPosts();
});

/* Helpers: file -> dataURL */
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* Utility show stats */
function refreshStats(){
  document.getElementById('statTotal').textContent = localStorage.getItem('vis_total') || 0;
  document.getElementById('statFB').textContent = localStorage.getItem('vis_fb') || 0;
  document.getElementById('statDirect').textContent = localStorage.getItem('vis_direct') || 0;
}

/* show ad on load if needed */
showAdIfNeeded();
refreshStats();
setActive(active);
renderPosts();

</script>
</body>
                </html>
